build:update:version:
  stage: build
  image: bitnami/git
  before_script:
    - !reference [.git_with_ssh:debian, before_script]
    - git remote set-url origin git@${CI_SERVER_HOST}:${CI_PROJECT_PATH}.git
    - |-
      if [[ ${CI_COMMIT_BRANCH} == "${CI_DEFAULT_BRANCH}" ]]; then
        VERSION=$(date +%y.%V.%y%V)
      else
        VERSION="${CI_COMMIT_BRANCH#coog-}.$(date +%y%V)"
      fi
  script:
    - |-
      for HELM_PROJECT in $(find . -mindepth 1 -maxdepth 1 -type d ! -name ".git" -exec basename {} \;)
      do
        if [ -f "${CI_PROJECT_DIR}/${HELM_PROJECT}/Chart.yaml" ]
        then
          git checkout ${CI_COMMIT_BRANCH}
          sed -i "/version: /c\version: ${VERSION}" "${CI_PROJECT_DIR}/${HELM_PROJECT}/Chart.yaml"
          git commit -am "Packaging ${VERSION}" || echo "Nothing to commit"
          git push
        fi
      done
  rules:
    - if: '$CI_PIPELINE_SOURCE =~ /^(schedule|trigger|pipeline)$/ && $CI_COMMIT_BRANCH =~ /^(master|coog-(([[:digit:]]{1,2}).([[:digit:]]{1,2})))$/'

deploy:helm-chart:
  stage: deploy
  image:
    name: alpine/helm
    entrypoint: [""] # avoid error message on start : Error: unknown command "sh" for "helm"
  variables:
    INSTALL_ADDITIONAL_PACKAGES: curl yq jq bash
  before_script:
    - !reference [.git_with_ssh:alpine, before_script]
    - git remote set-url origin git@${CI_SERVER_HOST}:${CI_PROJECT_PATH}.git
    - chmod u+x .gitlab/scripts/bash/package_helm_chart.bash
  script:
    - .gitlab/scripts/bash/package_helm_chart.bash
  artifacts:
    expire_in: 5 days
    paths:
      - "*.template"
    reports:
      dotenv: upload.env
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH =~ /^(master|coog-(([[:digit:]]{1,2}).([[:digit:]]{1,2})))$/'
      changes:
        - "**/Chart.yaml"

deploy:update:readme:
  stage: deploy
  image: golang:alpine
  variables:
    GO111MODULE: "on"
  before_script:
    - |-
      if [ "$HELM_NEW_CHART" != "true" ]; then
        echo "Charts didn't change, nothing to update"
        exit 0
      fi
    - !reference [.git_with_ssh:alpine, before_script]
    - go install github.com/norwoodj/helm-docs/cmd/helm-docs@latest
    - git remote set-url origin git@${CI_SERVER_HOST}:${CI_PROJECT_PATH}.git
  script:
    - helm-docs
    - git status | awk '/modified/{print $2}' | grep README.md | xargs git add
    - git commit -m "Generate README for charts with helm-docs"
    - git push origin HEAD:${CI_COMMIT_BRANCH}
  artifacts:
    expire_in: 2 hours
    paths:
      - "**/README.md"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH =~ /^(master|coog-(([[:digit:]]{1,2}).([[:digit:]]{1,2})))$/'
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH =~ /^(master|coog-(([[:digit:]]{1,2}).([[:digit:]]{1,2})))$/'
      changes:
        - "**/Chart.yaml"
  needs:
    - deploy:helm-chart
  allow_failure: true

deploy:coreye:coog:
  stage: deploy
  image: bitnami/git
  variables:
    REPOSITORY_SSH_KEY: "${SSH_KEY}"
    INSTALL_ADDITIONAL_PACKAGES: curl
  before_script:
    - |-
      if [ "$HELM_NEW_CHART" != "true" ]; then
        echo "Charts didn't change, nothing to update"
        exit 0
      fi
    - !reference [.git_with_ssh:debian, before_script]
  script:
    - git clone --single-branch --branch "${CI_COMMIT_REF_NAME}" https://${COREYE_REPO_USER}:${COREYE_REPO_TOKEN}@git.coreye.fr/coopengo/artifacts/coopengo_helm_charts.git
    - cd coopengo_helm_charts
    - git remote set-url origin https://${COREYE_REPO_USER}:${COREYE_REPO_TOKEN}@git.coreye.fr/coopengo/artifacts/coopengo_helm_charts.git
    - rm -rf coopengo_helm_charts/charts/coog
    - cp -R "${CI_PROJECT_DIR}/coog" charts/.
    - git add .
    - git commit -m "Synchronize Repository from Coopengo repository"
    - git push
    - echo "${HELM_PROJECT_VERSION}"
    - |-
      curl -X POST \
        -F token=${COREYE_TRIGGER_TOKEN} \
        -F ref=${CI_COMMIT_REF_NAME} \
        -F "variables[IMAGE_TAG]=${HELM_PROJECT_VERSION}" \
        -F "variables[SERVICE]=coog" \
        https://git.coreye.fr/api/v4/projects/434/trigger/pipeline
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH =~ /^(master|coog-(([[:digit:]]{1,2}).([[:digit:]]{1,2})))$/'
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH =~ /^(master|coog-(([[:digit:]]{1,2}).([[:digit:]]{1,2})))$/'
      changes:
        - "**/Chart.yaml"
  needs:
    - deploy:helm-chart
    - deploy:update:readme