# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: Test Istio VirtualService
templates:
  - virtualservice-istio.yaml
release:
  name: test # Do not edit
  namespace: test
capabilities:
  majorVersion: 1
  minorVersion: 29
tests:
  - it: Should not create VirtualService when Istio is disabled
    set:
      istio:
        enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: Should create VirtualService with basic configuration
    set:
      istio:
        enabled: true
        mainHost: coog.local
        gateway:
          routing:
            timeout: 600s
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: VirtualService
      - isAPIVersion:
          of: networking.istio.io/v1beta1
      - equal:
          path: metadata.name
          value: test-coog-routing
      - equal:
          path: metadata.namespace
          value: test
      - contains:
          path: spec.hosts
          content: "coog.local"
      - contains:
          path: spec.gateways
          content: test-coog-gateway

  - it: Should configure SAO redirect
    set:
      istio:
        enabled: true
        mainHost: coog.local
    asserts:
      - contains:
          path: spec.http
          content:
            match:
              - uri:
                  exact: /sao
            redirect:
              uri: "/"
              redirectCode: 301

  - it: Should route b2c traffic when enabled
    set:
      istio:
        enabled: true
        mainHost: coog.local
        gateway:
          routing:
            timeout: 3600s
      b2c:
        enabled: true
    asserts:
      - contains:
          path: spec.http
          content:
            match:
              - uri:
                  prefix: "/customers/myspace/"
            rewrite:
              uri: "/"
            route:
              - destination:
                  host: test-coog-b2c
                  port:
                    number: 80
            timeout: 3600s
      - contains:
          path: spec.http
          content:
            match:
              - uri:
                  exact: "/customers/myspace"
            redirect:
              uri: "/customers/myspace/"
              redirectCode: 301

  - it: Should route customer-backend traffic when enabled
    set:
      istio:
        enabled: true
        mainHost: coog.local
        gateway:
          routing:
            timeout: 600s
      customerBackend:
        enabled: true
    asserts:
      - contains:
          path: spec.http
          content:
            match:
              - uri:
                  prefix: "/v1/customer/"
            rewrite:
              uri: "/"
            route:
              - destination:
                  host: test-coog-customer-backend
                  port:
                    number: 80
            timeout: 600s
      - contains:
          path: spec.http
          content:
            match:
              - uri:
                  exact: "/v1/customer"
            redirect:
              uri: "/v1/customer/"
              redirectCode: 301

  - it: Should route customer-frontend traffic when enabled
    set:
      istio:
        enabled: true
        mainHost: coog.local
        gateway:
          routing:
            timeout: 3600s
      customerFrontend:
        enabled: true
    asserts:
      - contains:
          path: spec.http
          content:
            match:
              - uri:
                  prefix: "/customer/"
            rewrite:
              uri: "/"
            route:
              - destination:
                  host: test-coog-customer-frontend
                  port:
                    number: 80
            timeout: 3600s
      - contains:
          path: spec.http
          content:
            match:
              - uri:
                  exact: "/customer"
            redirect:
              uri: "/customer/"
              redirectCode: 301

  - it: Should route b2b traffic when enabled
    set:
      istio:
        enabled: true
        mainHost: coog.local
        gateway:
          routing:
            timeout: 3600s
      b2b:
        enabled: true
    asserts:
      - contains:
          path: spec.http
          content:
            match:
              - uri:
                  prefix: "/portal/"
            rewrite:
              uri: "/"
            route:
              - destination:
                  host: test-coog-b2b
                  port:
                    number: 80
            timeout: 3600s
      - contains:
          path: spec.http
          content:
            match:
              - uri:
                  exact: "/portal"
            redirect:
              uri: "/portal/"
              redirectCode: 301

  - it: Should route gateway traffic when frontCore is enabled
    set:
      istio:
        enabled: true
        mainHost: coog.local
        gateway:
          routing:
            timeout: 3600s
      frontCore:
        enabled: true
    asserts:
      - contains:
          path: spec.http
          content:
            match:
              - uri:
                  prefix: "/gateway/"
            rewrite:
              uri: "/"
            route:
              - destination:
                  host: test-coog-gateway
                  port:
                    number: 80
            timeout: 3600s
      - contains:
          path: spec.http
          content:
            match:
              - uri:
                  exact: "/gateway"
            redirect:
              uri: "/gateway/"
              redirectCode: 301

  - it: Should configure default route to coog service
    set:
      istio:
        enabled: true
        mainHost: coog.local
        gateway:
          routing:
            timeout: 1200s
    asserts:
      - contains:
          path: spec.http
          content:
            match:
              - uri:
                  prefix: "/docusign"
              - uri:
                  prefix: "/doc"
              - uri:
                  prefix: "/"
            route:
              - destination:
                  host: test-coog
                  port:
                    number: 80
            timeout: 1200s

  - it: Should configure retry policy when enabled
    set:
      istio:
        enabled: true
        mainHost: coog.local
        gateway:
          routing:
            timeout: 600s
            retry:
              attempts: 3
              perTryTimeout: 30s
              retryOn: "5xx,reset,connect-failure"
      b2c:
        enabled: true
    asserts:
      - contains:
          path: spec.http
          content:
            match:
              - uri:
                  prefix: "/customers/myspace/"
            rewrite:
              uri: "/"
            route:
              - destination:
                  host: test-coog-b2c
                  port:
                    number: 80
            timeout: 600s
            retries:
              attempts: 3
              perTryTimeout: 30s
              retryOn: "5xx,reset,connect-failure"

  - it: Should not configure retry policy when disabled
    set:
      istio:
        enabled: true
        mainHost: coog.local
        gateway:
          routing:
            timeout: 600s
      b2c:
        enabled: true
    asserts:
      - contains:
          path: spec.http
          content:
            match:
              - uri:
                  prefix: "/customers/myspace/"
            rewrite:
              uri: "/"
            route:
              - destination:
                  host: test-coog-b2c
                  port:
                    number: 80
            timeout: 600s

  - it: Should configure multiple routes when multiple services are enabled
    set:
      istio:
        enabled: true
        mainHost: coog.local
      b2c:
        enabled: true
      b2b:
        enabled: true
      customerBackend:
        enabled: true
      customerFrontend:
        enabled: true
      frontCore:
        enabled: true
    asserts:
      - isNotEmpty:
          path: spec.http
      # Verify routing precedence - more specific routes should come first
      - equal:
          path: spec.http[0].match[0].uri.exact
          value: /sao
      - equal:
          path: spec.http[1].match[0].uri.prefix
          value: "/customers/myspace/"
      - equal:
          path: spec.http[3].match[0].uri.prefix
          value: "/v1/customer/"
      - equal:
          path: spec.http[5].match[0].uri.prefix
          value: "/customer/"
      - equal:
          path: spec.http[7].match[0].uri.prefix
          value: "/portal/"
      - equal:
          path: spec.http[9].match[0].uri.prefix
          value: "/gateway/"
