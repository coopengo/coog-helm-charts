# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: Test Istio PeerAuthentication
templates:
  - peerauthentication-istio.yaml
release:
  name: test # Do not edit
  namespace: test
capabilities:
  majorVersion: 1
  minorVersion: 29
tests:
  - it: Should not create PeerAuthentication when Istio is disabled
    set:
      istio:
        enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: Should create PeerAuthentication with STRICT mTLS mode
    set:
      istio:
        enabled: true
        authentication:
          mtls:
            mode: STRICT
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: PeerAuthentication
      - isAPIVersion:
          of: security.istio.io/v1beta1
      - equal:
          path: metadata.name
          value: test-coog-authentication
      - equal:
          path: metadata.namespace
          value: test
      - equal:
          path: spec.mtls.mode
          value: STRICT

  - it: Should create PeerAuthentication with PERMISSIVE mTLS mode
    set:
      istio:
        enabled: true
        authentication:
          mtls:
            mode: PERMISSIVE
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: PeerAuthentication
      - equal:
          path: spec.mtls.mode
          value: PERMISSIVE

  - it: Should create PeerAuthentication with DISABLE mTLS mode
    set:
      istio:
        enabled: true
        authentication:
          mtls:
            mode: DISABLE
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: PeerAuthentication
      - equal:
          path: spec.mtls.mode
          value: DISABLE

  - it: Should create PeerAuthentication in correct namespace
    set:
      istio:
        enabled: true
        authentication:
          mtls:
            mode: STRICT
    asserts:
      - equal:
          path: metadata.namespace
          value: test
